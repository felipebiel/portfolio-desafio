<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/css/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <title>g1 - O portal de notícias da Globo</title>
</head>

<body>
    <header class="main-header">
        <img src="./assets/imgs/g1-logo.svg" alt="g1 - O portal de notícias da Globo"
            title="g1 - O portal de notícias da Globo">
        <figcaption class="main-header__logo--figcaption">g1 - O portal de notícias da Globo</figcaption>
        <h1 class="main-header__logo--figcaption">g1 - O portal de notícias da Globo</h1>
    </header>
    <div class="main-container main-container-flex">
        <main class="main-news-box">

            <article class="main-news-box__card">
                <h3 class="main-news-box__label">Cenário de destruição</h3>
                <h2 class="main-news-box__title">Equipes buscam desaparecidos da explosão que matou mais de 100 e feriu
                    4 mil no Líbano </h2>
                <p class="main-news-box__description">
                    Suspeita é de que a explosão aconteceu em um depósito de nitrato de amônio, um tipo de fertilizante,
                    na zona portuária de Beirute.
                </p>
            </article>
            <article class="main-news-box__card main-news-box__card--full-image"
                style="background-image: url('./assets/imgs/news-example.png');">
                <img src="./assets/imgs/news-example.png"
                    alt="Fotos mostram tamanho da destruição e desespero das vítimas"
                    title="Fotos mostram tamanho da destruição e desespero das vítimas" class="hidden">
                <figcaption class="hidden">Fotos mostram tamanho da destruição e desespero das
                    vítimas</figcaption>

                <h2 class="main-news-box__title main-news-box__title--full-image">Fotos mostram tamanho da destruição e
                    desespero das vítimas
                </h2>
            </article>
        </main>
        <section class="news-box">
            <section class="news-list-wrapper">
                <div id="news-list"> LISTA DE NOTICIAS</div>
                <div id="new-load-more">
                    <button class="btn btn-primary" id="load-more">Veja mais</button>
                </div>
            </section>

            <aside class="main-aside" id="new-group-box">
            </aside>
        </section>

    </div>
    <footer>
        <div class="main-container">
            <div class="footer-box">
                <img src="./assets/imgs/g1-logo.svg" alt="g1 - O portal de notícias da Globo"
                    title="g1 - O portal de notícias da Globo">
                <figcaption class="main-header__logo--figcaption">g1 - O portal de notícias da Globo</figcaption>
                <small>© Copyright 2000-2024 Globo Comunicação e Participações S.A</small>
            </div>
        </div>
    </footer>

    <script type="module">
        import { getNews, getNewsGroup } from './assets/js/services/api/news.js'
        import { formatDateByTime } from "./assets/js/utils/dates-functions.js";
        import { loadTemplate } from "./assets/js/utils/dom-functions.js";
        import { timer } from "./assets/js/utils/helpers.js";

        let page = 1;
        // Seleciona o container onde as notícias serão inseridas
        const newsList = document.getElementById('news-list');
        newsList.innerHTML = await loadTemplate('./assets/templates/news-skeleton.html');

        const loadMoreButton = document.getElementById('load-more')

        let news = await getNews(page);

        // Função para criar elementos de uma notícia
        async function createNewsItem(newsItem) {

            const newsContent = document.createElement('div');
            const isAd = newsList.childElementCount % 8;

            try {
                const templateText = await loadTemplate('./assets/templates/news-item.html');
                newsContent.innerHTML = templateText;

                // trata a imagem
                const image = newsContent.querySelector('.new-list-item__image-image')
                image.src = newsItem.image ? newsItem.image : './assets/imgs/G1-placeholder.webp';
                image.alt = newsItem.title;

                // trata o figcaption
                const figcaptionImage = newsContent.querySelector('figcaption')
                figcaptionImage.textContent = newsItem.title;

                // trata as informações da noticia
                const label = newsContent.querySelector('.new-list-item__label')
                label.textContent = newsItem.section;

                const title = newsContent.querySelector('.new-list-item__title')
                title.textContent = newsItem.title;

                const description = newsContent.querySelector('.new-list-item__description')
                description.textContent = newsItem.summary;

                const createAt = newsContent.querySelectorAll('.new-list-item__when')
                createAt.forEach(when => {
                    when.textContent = formatDateByTime(newsItem.created);
                })

            } catch (error) {
                newsContent.textContent = "Erro ao carregar as noticias, por favor tente novamente mais tarde."
            }

            newsList.appendChild(newsContent);

            if (isAd == 0) {
                const loadAd = await loadTemplate('./assets/templates/ad.html');
                const adContent = document.createElement('div');
                adContent.innerHTML = loadAd;
                newsList.appendChild(adContent);
            }
        }

        loadMoreButton.style.display = 'none';
        // simula timer API
        await timer(3000)

        for (const newsItem of news) {
            await createNewsItem(newsItem)
        }
        // remove skeleton ao final do processamento
        const skeleton = newsList.querySelector('.news-skeleton');
        skeleton.remove()

        loadMoreButton.style.display = 'block';

        // faz a paginação
        loadMoreButton.addEventListener('click', async () => {
            page = page + 1;
            news = await getNews(page);
            for (const newsItem of news) {
                await createNewsItem(newsItem)
            }
        })
    </script>

    <script type="module">
        import { getNews, getNewsGroup } from './assets/js/services/api/news.js'
        import { formatDateByTime } from "./assets/js/utils/dates-functions.js";
        import { loadTemplate } from "./assets/js/utils/dom-functions.js";
        import { timer } from "./assets/js/utils/helpers.js";

        /* ================================ AQUI*/

        const newsGroups = await getNewsGroup()
        const newsListGroup = document.getElementById('new-group-box');
        newsListGroup.innerHTML = await loadTemplate('./assets/templates/news-skeleton.html');

        async function createNewsGroupItem(newsItem) {

            const newsContent = document.createElement('div');

            try {

                // simula um timer da api
                await timer(3500)
                // apaga o skeleton
                newsListGroup.innerHTML = '';
                if (newsItem.group && newsItem.group.length > 0) {

                    const templateText = await loadTemplate('./assets/templates/news-group.html');
                    newsContent.innerHTML = templateText;

                    // trata o titulo do card
                    const titleCard = newsContent.querySelector('.new-group-box__title');
                    titleCard.textContent = newsItem.header

                    // trata a listagem das noticias
                    const contentList = newsContent.querySelector('.new-group-box__content-list');
                    const liElement = newsContent.querySelector('.new-group-box__content-item')
                    contentList.innerHTML = '';

                    newsItem.group.forEach(news => {
                        const cloneLi = liElement.cloneNode(true);
                        const link = cloneLi.querySelector('a');
                        link.href = news.content.url
                        link.textContent = news.content.title;
                        contentList.appendChild(cloneLi)
                    })
                }

            } catch (error) {
                newsContent.textContent = "Erro ao carregar as noticias, por favor tente novamente mais tarde."
            }

            newsListGroup.appendChild(newsContent);
        }

        newsGroups.forEach(newsItem => createNewsGroupItem(newsItem));
    </script>

</body>

</html>